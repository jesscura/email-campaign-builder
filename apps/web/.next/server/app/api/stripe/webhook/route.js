"use strict";(()=>{var e={};e.id=757,e.ids=[757],e.modules={20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},61282:e=>{e.exports=require("child_process")},84770:e=>{e.exports=require("crypto")},17702:e=>{e.exports=require("events")},32615:e=>{e.exports=require("http")},35240:e=>{e.exports=require("https")},21764:e=>{e.exports=require("util")},74064:(e,t,r)=>{r.r(t),r.d(t,{originalPathname:()=>g,patchFetch:()=>k,requestAsyncStorage:()=>m,routeModule:()=>f,serverHooks:()=>E,staticGenerationAsyncStorage:()=>v});var i={};r.r(i),r.d(i,{POST:()=>d});var s=r(17370),a=r(35317),n=r(2579),o=r(26567),u=r(85018),c=r(76435);async function d(e){let t;let r=await e.text(),i=e.headers.get("stripe-signature");if(!i)return o.NextResponse.json({error:"No signature provided"},{status:400});try{t=u.A.webhooks.constructEvent(r,i,process.env.STRIPE_WEBHOOK_SECRET)}catch(e){return console.error("Webhook signature verification failed:",e.message),o.NextResponse.json({error:"Invalid signature"},{status:400})}try{switch(t.type){case"checkout.session.completed":{let e=t.data.object;await p(e);break}case"customer.subscription.created":case"customer.subscription.updated":{let e=t.data.object;await l(e);break}case"customer.subscription.deleted":{let e=t.data.object;await b(e);break}case"invoice.payment_succeeded":{let e=t.data.object;await w(e);break}case"invoice.payment_failed":{let e=t.data.object;await h(e);break}default:console.log(`Unhandled event type: ${t.type}`)}return o.NextResponse.json({received:!0})}catch(e){return console.error("Error handling webhook:",e),o.NextResponse.json({error:"Webhook handler failed"},{status:500})}}async function p(e){let t=e.metadata?.userId,r=e.metadata?.planId;if(!t||!r){console.error("Missing metadata in checkout session");return}let i=await u.A.subscriptions.retrieve(e.subscription);await c.Z.user.update({where:{id:t},data:{planId:r,subscriptionId:i.id,subscriptionStatus:"ACTIVE",currentPeriodEnd:new Date(1e3*i.current_period_end)}})}async function l(e){let t=await c.Z.user.findFirst({where:{subscriptionId:e.id}});if(!t){console.error("User not found for subscription:",e.id);return}let r=function(e){switch(e){case"active":return"ACTIVE";case"trialing":return"TRIALING";case"past_due":return"PAST_DUE";case"canceled":case"unpaid":return"CANCELED";default:return"INACTIVE"}}(e.status);await c.Z.user.update({where:{id:t.id},data:{subscriptionStatus:r,currentPeriodEnd:new Date(1e3*e.current_period_end)}})}async function b(e){let t=await c.Z.user.findFirst({where:{subscriptionId:e.id}});if(!t){console.error("User not found for subscription:",e.id);return}let r=await c.Z.plan.findFirst({where:{name:"Free"}});await c.Z.user.update({where:{id:t.id},data:{planId:r?.id,subscriptionId:null,subscriptionStatus:"CANCELED",currentPeriodEnd:null}})}async function w(e){let t=e.subscription;if(!t||"string"!=typeof t)return;let r=await u.A.subscriptions.retrieve(t);await l(r)}async function h(e){let t=e.subscription;if(!t||"string"!=typeof t)return;let r=await c.Z.user.findFirst({where:{subscriptionId:t}});r&&await c.Z.user.update({where:{id:r.id},data:{subscriptionStatus:"PAST_DUE"}})}let f=new s.AppRouteRouteModule({definition:{kind:a.x.APP_ROUTE,page:"/api/stripe/webhook/route",pathname:"/api/stripe/webhook",filename:"route",bundlePath:"app/api/stripe/webhook/route"},resolvedPagePath:"/home/runner/work/email-builder/email-builder/apps/web/app/api/stripe/webhook/route.ts",nextConfigOutput:"standalone",userland:i}),{requestAsyncStorage:m,staticGenerationAsyncStorage:v,serverHooks:E}=f,g="/api/stripe/webhook/route";function k(){return(0,n.patchFetch)({serverHooks:E,staticGenerationAsyncStorage:v})}},76435:(e,t,r)=>{r.d(t,{Z:()=>s});let i=require("@prisma/client"),s=globalThis.prisma??new i.PrismaClient({log:["error"]})},85018:(e,t,r)=>{r.d(t,{A:()=>a});var i=r(24091);let s=process.env.STRIPE_SECRET_KEY||"sk_test_placeholder",a=new i.Z(s,{apiVersion:"2025-09-30.clover",typescript:!0})}};var t=require("../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),i=t.X(0,[910,145,91],()=>r(74064));module.exports=i})();