"use strict";(()=>{var e={};e.id=413,e.ids=[413],e.modules={20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},84770:e=>{e.exports=require("crypto")},96408:(e,t,r)=>{r.r(t),r.d(t,{originalPathname:()=>_,patchFetch:()=>h,requestAsyncStorage:()=>p,routeModule:()=>l,serverHooks:()=>f,staticGenerationAsyncStorage:()=>d});var n={};r.r(n),r.d(n,{GET:()=>u});var o=r(17370),a=r(35317),i=r(2579),s=r(26567),c=r(70936);async function u(e){let t=e.nextUrl.searchParams.get("code");if(!t)return s.NextResponse.redirect(new URL("/settings?error=missing_code",e.url));let r=await (0,c.ZI)(t,e);if(!r.access_token)return s.NextResponse.redirect(new URL("/settings?error=auth_failed",e.url));let n=s.NextResponse.redirect(new URL("/settings",e.url));return n.headers.set("Set-Cookie",(0,c.bm)(r)),n}let l=new o.AppRouteRouteModule({definition:{kind:a.x.APP_ROUTE,page:"/api/zoho/callback/route",pathname:"/api/zoho/callback",filename:"route",bundlePath:"app/api/zoho/callback/route"},resolvedPagePath:"/home/runner/work/email-builder/email-builder/apps/web/app/api/zoho/callback/route.ts",nextConfigOutput:"standalone",userland:n}),{requestAsyncStorage:p,staticGenerationAsyncStorage:d,serverHooks:f}=l,_="/api/zoho/callback/route";function h(){return(0,i.patchFetch)({serverHooks:f,staticGenerationAsyncStorage:d})}},70936:(e,t,r)=>{r.d(t,{CB:()=>f,N6:()=>S,XI:()=>h,Xk:()=>_,ZI:()=>v,bf:()=>b,bm:()=>g,fZ:()=>k,kP:()=>R});var n=r(84770),o=r.n(n);let a=process.env.ZOHO_CLIENT_ID||"",i=process.env.ZOHO_CLIENT_SECRET||"",s=process.env.ZOHO_REDIRECT_URI||"",c=process.env.ZOHO_BASE_URL||"https://accounts.zoho.com",u=process.env.ENCRYPTION_SECRET||"dev-secret-unsafe";function l(e){let t=o().randomBytes(16),r=o().createHash("sha256").update(u).digest(),n=o().createCipheriv("aes-256-cbc",r,t),a=Buffer.concat([n.update(JSON.stringify(e),"utf8"),n.final()]).toString("base64");return`${t.toString("base64")}.${a}`}function p(e){let[t,r]=e.split("."),n=Buffer.from(t,"base64"),a=o().createHash("sha256").update(u).digest(),i=o().createDecipheriv("aes-256-cbc",a,n);return JSON.parse(Buffer.concat([i.update(Buffer.from(r,"base64")),i.final()]).toString("utf8"))}let d="zoho_cfg";function f(e){let t=e.cookies.get(d)?.value;if(!t)return null;try{return p(t)}catch{return null}}function _(e){return`${d}=${l(e)}; Path=/; HttpOnly; Secure; SameSite=Lax; Max-Age=31536000`}function h(){return`${d}=; Path=/; HttpOnly; Secure; SameSite=Lax; Max-Age=0`}let m="zoho_session";function g(e){let t={access_token:e.access_token,refresh_token:e.refresh_token,expires_in:Date.now()+1e3*(e.expires_in||3600)};return`${m}=${l(t)}; Path=/; HttpOnly; Secure; SameSite=Lax; Max-Age=2592000`}function k(){return`${m}=; Path=/; HttpOnly; Secure; SameSite=Lax; Max-Age=0`}function b(e){let t=e.cookies.get(m)?.value;if(!t)return null;try{return p(t)}catch{return null}}function x(e){let t=e?f(e):null,r=t?.client_id||a,n=t?.client_secret||i,o=t?.redirect_uri||s,u=t?.base_url||c;return r?{client_id:r,client_secret:n,redirect_uri:o,base_url:u}:null}function S(e){let t=x(e);if(!t?.client_id)return null;let r=encodeURIComponent("ZohoCRM.modules.ALL,ZohoCRM.settings.ALL");return`${t.base_url}/oauth/v2/auth?response_type=code&client_id=${t.client_id}&scope=${r}&redirect_uri=${encodeURIComponent(t.redirect_uri)}&access_type=offline&prompt=consent`}async function v(e,t){let r=x(t);if(!r)return{error:"Missing Zoho config"};let n=`${r.base_url}/oauth/v2/token?grant_type=authorization_code&client_id=${r.client_id}&client_secret=${r.client_secret}&redirect_uri=${encodeURIComponent(r.redirect_uri)}&code=${encodeURIComponent(e)}`,o=await fetch(n,{method:"POST"});return await o.json()}async function $(e,t){let r=x(t);if(!r)return{error:"Missing Zoho config"};let n=`${r.base_url}/oauth/v2/token?grant_type=refresh_token&client_id=${r.client_id}&client_secret=${r.client_secret}&refresh_token=${encodeURIComponent(e)}`,o=await fetch(n,{method:"POST"});return await o.json()}async function w(e,t){if(!e)return null;if(e.expires_in&&e.expires_in>Date.now()+6e4)return e.access_token;if(e.refresh_token){let r=await $(e.refresh_token,t);if(r.access_token)return r.access_token}return e.access_token||null}async function R(e,t){let r=x(e);if(!r?.client_id)return"/crm/v3/settings/modules"===t?{modules:[{api_name:"Leads",module_name:"Leads"},{api_name:"Contacts",module_name:"Contacts"}]}:t.startsWith("/crm/v3/settings/fields")?{fields:[{api_name:"First_Name",field_label:"First Name"},{api_name:"Last_Name",field_label:"Last Name"},{api_name:"Company",field_label:"Company"}]}:"/userinfo"===t?{email:"mock@zoho.local"}:{};let n=b(e),o=await w(n,e);if(!o)throw Error("No access token; connect Zoho in Settings");let a=await fetch(`https://www.zohoapis.com${t}`,{headers:{Authorization:`Zoho-oauthtoken ${o}`}});if(!a.ok)throw Error(`Zoho error: ${a.status}`);return await a.json()}}};var t=require("../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),n=t.X(0,[910,145],()=>r(96408));module.exports=n})();